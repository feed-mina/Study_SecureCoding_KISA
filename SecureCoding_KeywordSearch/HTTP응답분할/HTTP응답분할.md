# HTTP 응답분할
## HTTP 응답분할이란?
### 참고사이트: OWASP
* **[https://owasp.org/www-community/attacks/HTTP_Response_Splitting]**(https://owasp.org/www-community/attacks/HTTP_Response_Splitting)

HTTP 응답 분할은 다음과 같은 경우에 발생한다. 
1_ 데이터는 신뢰할 수 없는 출처에서 유입된다. 가장 흔한 경로는 HTTP 요청을 통해 웹 애플리케이션으로 전달되는 경우이다.
2_ 이 데이터는 악성 문자에 대한 유효성 검사를 거치지 않은 상태로 웹 사용자에게 전송되는 HTTP 응답 헤더에 포함될 수 있다.

HTTP 응답 분할은 그 자체가 목적이 아니라 공격을 달성하기 위한 수단이다.
공격의 기본 원리는 단순하다.
공격자는 취약한 애플리케이션에 악성 데이터를 전달한다.
애플리케이션은 해당 데이터를 HTTP 응답 헤더에 그대로 포함시킨다.

공격을 성공적으로 수행하려면 애플리케이션이 헤더에 CR(캐리지 리턴, %0d 또는 \r로 표기) 및 LF(라인 피드, %0a 또는 \n로 표기) 문자를 포함하는 입력을 허용해야 한다.
기본 플랫폼 또한 이러한 문자의 삽입에 취약해야 한다.

이러한 문자를 이용하면 공격자는 애플리케이션이 전송하려는 응답의 나머지 헤더와 본문을 제어할 수 있다.
또한 공격자는 완전히 제어 가능한 추가 HTTP 응답을 생성할 수도 있다.

아래 예시는 Java를 사용하지만, 이 문제는 거의 모든 최신 Java EE 애플리케이션 서버에서 해결되었다.
만약 이 위험이 우려된다면 해당 플랫폼에서 CR 또는 LF 문자가 헤더에 삽입될 수 있는지 테스트해야 한다.
일반적으로 이 취약점은 코드 작성 언어와 관계없이 대부분의 최신 애플리케이션 서버에서 해결되었을 것으로 예상된다.

다음 코드 조각은 HTTP 요청에서 웹 로그 게시물 작성자의 이름(author)을 읽어 HTTP 응답의 쿠키 헤더에 설정하는 예시이다.
String author = request.getParameter(AUTHOR_PARAM);
Cookie cookie = new Cookie("author", author);
cookie.setMaxAge(cookieExpiration);
response.addCookie(cookie);

요청에 "Jane Smith"와 같은 표준 영숫자 문자열이 포함된 경우 HTTP 응답은 다음과 같은 형식을 가진다.
HTTP/1.1 200 OK
Set-Cookie: author=Jane Smith

그러나 쿠키 값은 유효성 검사를 거치지 않은 사용자 입력으로 구성된다.
따라서 AUTHOR_PARAM에 제출된 값에 CR 및 LF 문자가 포함되지 않은 경우에만 응답이 정상 형식을 유지한다.

공격자가 "Wiley Hacker \r\nContent-Length: 999\r\n\r\n..."와 같은 악의적인 문자열을 제출하면 HTTP 응답은 분리된다.
이 경우 위조된 응답과 원래 응답이 분리되어 전송된다.

HTTP/1.1 200 OK
Set-Cookie: author=Wiley Hacker
Content-Length: 999

<html>malicious content...</html>  
이 예시에서는 999번째 문자까지 악성 콘텐츠가 포함된다.  
1000번째 문자부터 시작하는 원래 콘텐츠는 웹 브라우저에서 무시된다.

공격자가 임의의 HTTP 응답을 구성할 수 있다는 점은 다양한 공격을 가능하게 한다.
여기에는 사용자 인터페이스 변조, 캐시 포이즈닝, 크로스 사이트 스크립팅, 페이지 하이재킹 등이 포함된다.

## CWE-113: HTTP 헤더에서 CRLF 시퀀스의 부적절한 적용 (HTTP 요청/응답 분할)
### 참고사이트 : CWE
* **[https://cwe.mitre.org/data/definitions/113.html]**(https://cwe.mitre.org/data/definitions/113.html)

HTTP 에이전트 또는 컴포넌트는 웹 서버, 프록시, 브라우저 등으로부터 데이터를 수신한다.
이때 데이터를 송신할 HTTP 메시지에 포함하기 전에 CR 및 LF 문자를 중화하지 않거나 잘못 중화하는 경우 취약점이 발생한다.

HTTP 에이전트 또는 구성 요소에는 웹 서버, 로드 밸런서, 리버스 프록시, 웹 캐싱 프록시, 애플리케이션 방화벽, 웹 브라우저 등이 포함될 수 있다.
역할에 관계없이 모든 구성 요소 간에는 일관되고 안정적인 HTTP 통신 상태가 유지되어야 한다.

그러나 HTTP 헤더에 예상치 못한 데이터가 포함되면 문제가 발생한다.
클라이언트 HTTP 에이전트(웹 브라우저) 또는 백엔드 HTTP 에이전트(서버)가 렌더링하는 HTTP 메시지 전체가 공격자에 의해 지정될 수 있다.

이 메시지는 요청의 일부일 수도 있고 응답의 일부일 수도 있다.
HTTP 요청에 예상치 못한 CR 및 LF 문자가 포함된 경우 서버는 이를 하나의 HTTP 메시지가 아닌 두 개의 메시지로 분할하여 해석할 수 있다.

CR은 캐리지 리턴(%0d 또는 \r)을 의미한다.
LF는 줄바꿈(%0a 또는 \n)을 의미한다.
CR 및 LF 외에도 HT(가로 탭, %09 또는 \t), SP(공백, + 또는 %20)와 같은 특수 문자도 사용될 수 있다.

HTTP 메시지 헤더에 검증되지 않은 예상치 못한 데이터가 포함되면 공격자는 두 번째 분할 메시지를 제어할 수 있다.
이를 통해 요청 위조, 크로스 사이트 스크립팅, 캐시 포이즈닝과 같은 공격이 가능해진다.

HTTP 응답 분할 취약점의 특징은 다음과 같다.
데이터는 신뢰할 수 없는 출처에서 HTTP 요청을 통해 웹 애플리케이션으로 유입된다.
해당 데이터는 헤더 구분 문자로 오인될 수 있는 상태임에도 제거되지 않은 채 HTTP 응답 헤더에 포함된다.

HTTP 헤더에 포함된 CR 및 LF 문자는 공격자에게 권한을 부여한다.
공격자는 애플리케이션이 송수신하려는 메시지의 나머지 헤더와 본문을 제어할 수 있다.
또한 공격자는 완전히 제어 가능한 추가 HTTP 메시지를 생성할 수 있다.
참고: [https://cwe.mitre.org/data/definitions/113.html](https://cwe.mitre.org/data/definitions/113.html)

